<html>
	<head>
		<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>

		<script type="text/javascript">
			"use strict";

			var mainSchema = "CSLEDIT.mainSchema",
				subSchemas = "CSLEDIT.subSchemas";

			var updateView = function () {
				var mainList = $('#mainSchemaList'),
					subList = $('#subSchemasList'),
					mainSchemaData = JSON.parse(localStorage.getItem(mainSchema)),
					subSchemasData = JSON.parse(localStorage.getItem(subSchemas));

				mainList.children().remove();
				subList.children().remove();

				if (mainSchemaData === null) {
					mainList.append("<li>Main schema file not specified</li>");
				} else {
					$.each(mainSchemaData, function (name, data) {
						mainList.append("<li>" + name + "</li>");
					});
				}

				if (subSchemasData === null) {
					subList.append("<li>No sub schemas specified</li>");
				} else {
					$.each(subSchemasData, function (name, data) {
						subList.append("<li>" + name + "</li>");
					});
				}
			}

			var readSchemaFiles = function (schemaKey, files) {
				var schemaData = {};

				$.each(files, function (i, file) {
					var reader = new FileReader();

					reader.onload = function (event) {
						schemaData[file.name] = event.target.result;
					
						localStorage.setItem(schemaKey, JSON.stringify(schemaData));
						updateView();
					};
					reader.readAsText(file);
				});

				return schemaData;
			};

			$(document).ready(function () {
				if (typeof(localStorage) === "undefined" || localStorage === null) {
					$('body').html("localStorage not available in this environment");
				}

				$("#mainSchemaFile").change(function (event) {
					readSchemaFiles(mainSchema, event.target.files);
				});
				$("#subSchemasFiles").change(function (event) {
					readSchemaFiles(subSchemas, event.target.files);
				});

				$("#deleteSchema").click(function () {
					localStorage.removeItem(mainSchema);
					localStorage.removeItem(subSchemas);

					updateView();
				});
				
				$("#resetEverything").click(function () {
					localStorage.clear();
					alert("All local settings removed");
				});

				updateView();
			});

		</script>
		
	</head>
	<body>
		<h3>Current CSL schema files</h3>

		<label for="mainSchemaFile">Main CSL Schema RNG File:</label><input id="mainSchemaFile" type="file"></input><br />
		<ul id="mainSchemaList"></ul>

		<label for="subSchemasFiles">Other CSL Schema RNG Files:</label><input id="subSchemasFiles" type="file" multiple="multiple"></input><br />
		<ul id="subSchemasList"></ul>

		<button id="deleteSchema">Delete All Files (reset schema to default)</button>

		<h3>Reset everything</h3>
		<button id="resetEverything">Reset all local settings to default (your style will be lost)</button>

		<p>

		<h3>CSL Editor</h3>
		<a href="../visualEditor">
			Go to Visual Editor page
		</a> (these settings will be remembered, return back to this page is you want to change them)
		</p>
	</body>
</html>
